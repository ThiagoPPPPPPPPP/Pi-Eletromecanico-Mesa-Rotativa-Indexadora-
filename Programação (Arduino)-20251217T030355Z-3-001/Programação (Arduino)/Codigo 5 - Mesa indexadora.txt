
LINK DO PROJETO: https://wokwi.com/projects/449093866708450305

// ======================================================
//                    MESA INDEXADORA 
// ======================================================

// ================================
//       SENSORES IND + CAP 
// ================================
#define SENIND1 66   // Indutivo Entrada
#define SENIND2 67   // Indutivo Sa√≠da
#define SENC1   68   // Capacitivo Entrada
#define SENC2   69   // Capacitivo Sa√≠da

// ================================
//               LEDS
// ================================
#define LED1 34
#define LED2 36
#define LED3 38
#define LED4 40

// ================================
//         SOLENOIDE 
// ================================
#define CARGA    41
#define TRIGGER  39

// ================================
//             MOTOR
// ================================
#define STEP_PIN   37
#define DIR_PIN    35
#define PASSOS_POR_POSICAO 533   // ajuste fino
#define VELOCIDADE_US 800        // delay do motor (microseconds)

// ================================
//           VARI√ÅVEIS
// ================================
bool pecas[6] = {0,0,0,0,0,0}; // slots de pe√ßas
bool mesaLigada = false;
bool cicloAtivo = false;

unsigned long marcaTempo = 0;
const unsigned long tempoEtapa = 4000;  // tempo entre posi√ß√µes

// vari√°veis IHM 
int v15 = 0, v16 = 0, v17 = 0, v18 = 0;

// forward declarations 
void desligarTudo();
bool detectarPecaEntrada();
void ligarMesa();
void cicloIndexador();
void leituraMaterial(int idx);
void expulsarPeca();
void finalizarCiclo();
void moverPosicao();
void moverEtapa(int pos);
void exibirStatus();
void IHM();

// ======================================================
//                     SETUP
// ======================================================
void setup() {
  Serial.begin(9600);

  pinMode(SENIND1, INPUT);
  pinMode(SENIND2, INPUT);
  pinMode(SENC1, INPUT);
  pinMode(SENC2, INPUT);

  pinMode(LED1,OUTPUT);
  pinMode(LED2,OUTPUT);
  pinMode(LED3,OUTPUT);
  pinMode(LED4,OUTPUT);

  pinMode(CARGA,OUTPUT);
  pinMode(TRIGGER,OUTPUT);

  pinMode(STEP_PIN,OUTPUT);
  pinMode(DIR_PIN,OUTPUT);

  desligarTudo();
  Serial.println("==== SISTEMA PRONTO ====");
}

// ======================================================
//                        LOOP
// ======================================================
void loop(){  
  // mostra LEDs conforme sensores na IHM
  IHM();

  if(!mesaLigada && detectarPecaEntrada()){
      ligarMesa();
  }

  if(mesaLigada && cicloAtivo){
      cicloIndexador();
  }
}

// ======================================================
//              DETECTA PE√áA NA ENTRADA
// ======================================================
bool detectarPecaEntrada(){
  return (digitalRead(SENIND1)==1 || digitalRead(SENC1)==1);
}

// ======================================================
//                   LIGAR MESA
// ======================================================
void ligarMesa(){
  mesaLigada = true;
  cicloAtivo = true;
  Serial.println("\nüî• Sistema iniciado ‚Äî pe√ßa detectada na entrada");

  moverPosicao();      // move a pe√ßa da posi√ß√£o 1 
  pecas[0] = 1;         // registra pe√ßa
  exibirStatus();
}

// ======================================================
//               CICLO COMPLETO DO PROCESSO
// ======================================================
void cicloIndexador(){
  static int etapa = 0;

  if(millis()-marcaTempo < tempoEtapa) return;
  marcaTempo = millis();

  switch(etapa){

    case 0:
      moverEtapa(1); 
      break; // posi√ß√£o 2

    case 1:
      moverEtapa(2); 
      break; // posi√ß√£o 3

    case 2:
      moverEtapa(3); 
      leituraMaterial(3); 
      break;

    case 3:
      moverEtapa(4); 
      leituraMaterial(4);
      break;

    case 4:
      moverEtapa(5); 
      expulsarPeca();  
      finalizarCiclo(); 
      etapa = 0;   // reset da etapa para pr√≥ximo ciclo
      return;

    default:
      etapa=0; 
      return;
  }

  etapa++;
}

// ======================================================
//         LEITURA DOS TIPOS DE MATERIAL
// ======================================================
void leituraMaterial(int idx){
  bool metal = (digitalRead(SENIND2) == HIGH);
  bool plast = (digitalRead(SENC2) == HIGH);

  if(metal) {
    pecas[idx] = 1;
    Serial.println("‚Üí Material: MET√ÅLICO");
  }
  else if(plast){
    pecas[idx] = 2;
    Serial.println("‚Üí Material: N√ÉO MET√ÅLICO");
  }
  else Serial.println("‚Üí Sem leitura v√°lida...");
}

// ======================================================
//                EXPULS√ÉO FINAL
// ======================================================
void expulsarPeca(){
  Serial.println("‚ö† Expulsando pe√ßa...");

  digitalWrite(CARGA,HIGH); 
  delay(300);
  
  digitalWrite(CARGA,LOW);  
  delay(200);
  
  digitalWrite(TRIGGER,HIGH);
  delay(200);
  
  digitalWrite(TRIGGER,LOW);

  pecas[5]=0;
}

// ======================================================
//                   FINALIZAR CICLO
// ======================================================
void finalizarCiclo(){
  Serial.println("\n‚úî Ciclo completo. Sistema aguardando nova pe√ßa.");
  cicloAtivo=false;
  mesaLigada=false;
  desligarTudo();
}

// ======================================================
//                   MOTOR ‚Äî 1 POSI√á√ÉO
// ======================================================
void moverPosicao(){
  digitalWrite(DIR_PIN,HIGH);
  for(int i=0;i<PASSOS_POR_POSICAO;i++){
    digitalWrite(STEP_PIN,HIGH); delayMicroseconds(VELOCIDADE_US);
    digitalWrite(STEP_PIN,LOW);  delayMicroseconds(VELOCIDADE_US);
  }
}

// desloca vetor de posi√ß√£o
void moverEtapa(int pos){
  moverPosicao();
  for(int i=5;i>0;i--) pecas[i] = pecas[i-1];
  pecas[0]=0;
  Serial.print("\n‚û° Mesa avan√ßou para posi√ß√£o ");
  Serial.println(pos+1);
  exibirStatus();
}

// ======================================================
//              MOSTRAR STATUS NO SERIAL
// ======================================================
void exibirStatus(){
  Serial.print("Estado da mesa: ");
  for(int i=0;i<6;i++){ Serial.print(pecas[i]); Serial.print(" "); }
  Serial.println();
}

// ======================================================
//                       IHM
// ======================================================
void IHM() {
  // l√™ sensores e atualiza vari√°veis locais (v15..v18)
  v15 = digitalRead(SENIND1);
  v16 = digitalRead(SENIND2);
  v17 = digitalRead(SENC1);
  v18 = digitalRead(SENC2);

  //LEDS IHM
  if (v15 != 1 && v16 == 1 && v17 == 0 && v18 == 0) {
    digitalWrite(LED1, LOW);
    digitalWrite(LED2, HIGH);
    digitalWrite(LED3, HIGH);
    digitalWrite(LED4, HIGH);
  } else if (v15 == 1 && v16 != 1 && v17 == 0 && v18 == 0) {
    digitalWrite(LED1, HIGH);
    digitalWrite(LED2, LOW);
    digitalWrite(LED3, HIGH);
    digitalWrite(LED4, HIGH);
  } else if (v15 == 1 && v16 == 1 && v17 != 0 && v18 == 0) {
    digitalWrite(LED1, HIGH);
    digitalWrite(LED2, HIGH);
    digitalWrite(LED3, LOW);
    digitalWrite(LED4, HIGH);
  } else if (v15 == 1 && v16 == 1 && v17 == 0 && v18 != 0) {
    digitalWrite(LED1, HIGH);
    digitalWrite(LED2, HIGH);
    digitalWrite(LED3, HIGH);
    digitalWrite(LED4, LOW);
  } else {
    // todos ON
    digitalWrite(LED1, HIGH);
    digitalWrite(LED2, HIGH);
    digitalWrite(LED3, HIGH);
    digitalWrite(LED4, HIGH);
  }
}

// ======================================================
//             RESET EM TODAS SAIDAS/LEDS
// ======================================================
void desligarTudo(){
  digitalWrite(CARGA,LOW);
  digitalWrite(TRIGGER,LOW);
  digitalWrite(LED1,HIGH);
  digitalWrite(LED2,HIGH);
  digitalWrite(LED3,HIGH);
  digitalWrite(LED4,HIGH);
}

// ======================================================
//           M√ìDULOS EM BRANCO PARA UPGRADES FUTUROS
// ======================================================
void moduloExtra1() {}
void moduloExtra2() {}
void moduloExtra3() {}
void moduloExtra4() {}

//======================================================
//======================================================